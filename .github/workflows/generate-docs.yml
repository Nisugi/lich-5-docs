name: Generate Documentation

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'LLM Provider to use'
        required: true
        default: 'openai'
        type: choice
        options:
          - openai
          - anthropic
          - gemini
          - mock
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'elanthia-online/lich-5'
      source_branch:
        description: 'Branch to document'
        required: true
        default: 'main'
      full_rebuild:
        description: 'Full rebuild (vs incremental)'
        required: true
        type: boolean
        default: false

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout documentation repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Clone Lich repository
      run: |
        git clone https://github.com/${{ inputs.source_repo }}.git lich-source
        cd lich-source
        git checkout ${{ inputs.source_branch }}

    - name: Validate environment
      env:
        LLM_PROVIDER: ${{ inputs.provider }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python -c "
        import os
        import sys
        sys.path.insert(0, 'src')
        from providers import ProviderFactory

        validation = ProviderFactory.validate_environment()
        print(f'Provider: {validation[\"provider\"]}')
        print(f'Valid: {validation[\"valid\"]}')

        if not validation['valid']:
            print(f'Missing: {validation[\"missing\"]}')
            sys.exit(1)

        for warning in validation.get('warnings', []):
            print(f'Warning: {warning}')
        "

    - name: Generate documentation
      env:
        LLM_PROVIDER: ${{ inputs.provider }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Generating documentation with ${{ inputs.provider }} provider"
        if [ "${{ inputs.full_rebuild }}" == "true" ]; then
          echo "Running FULL REBUILD (all files will be reprocessed)"
          python generate_docs.py lich-source/lib --provider ${{ inputs.provider }} --yard --force-rebuild --output output/latest
        else
          echo "Running INCREMENTAL build (skipping already processed files)"
          python generate_docs.py lich-source/lib --provider ${{ inputs.provider }} --yard --output output/latest
        fi

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: false

    - name: Install YARD
      run: |
        gem install yard
        gem install redcarpet  # For markdown support in YARD
        yard --version

    - name: Generate HTML Documentation with YARD
      run: |
        # Use the consistent output directory
        OUTPUT_DIR="output/latest"
        echo "Using output directory: $OUTPUT_DIR"

        # Create temporary directory for documented Ruby files
        mkdir -p temp_yard_input
        cp -r $OUTPUT_DIR/documented/* temp_yard_input/ 2>/dev/null || true

        # Generate HTML documentation using YARD
        echo "Generating HTML documentation with YARD..."
        cd temp_yard_input
        yard doc --output-dir ../docs \
                 --title "Lich-5 Documentation" \
                 --readme ../README.md \
                 --markup markdown \
                 --markup-provider redcarpet \
                 --charset utf-8 \
                 --no-private \
                 **/*.rb

        cd ..
        echo "HTML documentation generated in docs/"

        # Add a custom landing page if YARD didn't create one
        if [ ! -f docs/index.html ]; then
          echo "Creating custom index.html..."
          cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
  <title>Lich-5 Documentation</title>
  <meta http-equiv="refresh" content="0; url=frames.html">
</head>
<body>
  <p>Redirecting to <a href="frames.html">documentation</a>...</p>
</body>
</html>
EOF
        fi

        # Clean up temporary directory
        rm -rf temp_yard_input

    - name: Clean up cloned repository
      run: |
        # Remove the cloned Lich repository to avoid committing it
        rm -rf lich-source
        echo "Cleaned up lich-source directory"

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Update documentation [skip ci]'
        branch: docs-update-${{ github.run_number }}
        title: 'Documentation Update from ${{ inputs.source_repo }}'
        body: |
          ## Documentation Update

          - **Provider:** ${{ inputs.provider }}
          - **Source:** ${{ inputs.source_repo }} @ ${{ inputs.source_branch }}
          - **Type:** ${{ inputs.full_rebuild && 'Full rebuild' || 'Incremental' }}
          - **Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Files Included:
          - `docs/` - HTML documentation for GitHub Pages
          - `output/latest/` - Generated YARD files and manifest for incremental builds
          - `output/latest/manifest.json` - Tracks processed files for next run

          Please review the generated documentation before merging.
        labels: documentation, automated
        add-paths: |
          docs/**
          output/latest/**

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-${{ github.run_number }}
        path: output/
        retention-days: 30